{% extends 'dashboard-base.html' %}
{% block dashboard_section %}
<section class="my-3">
    <div class="container d-none">
        <div class="row">
            <div class="col-md-6 col-lg-4 col-xl-3 mb-3">
                <div class="card custom-card">
                    <div class="row">
                        <div class="col text-center my-2">
                            <h3>Account Management</h3>
                            <i class="fas fa-user fa-5x my-3"></i>
                            <h3 class="card-title">{{accounts.current}} &#47; {{accounts.max}}</h3>
                            <h5><a href="{% url 'agency_employee_create' %}" class="card-link">Add Account</a></h5>
                            <h5><a href="{% url 'dashboard_account_list' %}" class="card-link">View Accounts</a></h5>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-4 col-xl-3 mb-3">
                <div class="card custom-card">
                    <div class="row">
                        <div class="col text-center my-2">
                            <h3>Agency <br/>Management</h3>
                            <i class="fas fa-building fa-5x my-3"></i>
                            <h3 class="card-title">{{branches.current}}</h3>
                            <h5><a href="{% url 'dashboard_branches_list' %}" class="card-link">View Branches</a></h5>
                            <h5><a href="{% url 'dashboard_agency_detail' %}" class="card-link">View Agency Details</a></h5>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-4 col-xl-3 mb-3">
                <div class="card custom-card">
                    <div class="row">
                        <div class="col text-center my-2">
                            <h3>FDW <br/>Biodata</h3>
                            <i class="fas fa-portrait fa-5x my-3"></i>
                            <h3 class="card-title">{{biodata.current}} &#47; {{biodata.max}}</h3>
                            <h5><a href="{% url 'maid_create' %}" class="card-link">Add Biodata</a></h5>
                            <h5><a href="{% url 'dashboard_maid_list' %}" class="card-link">View Biodata</a></h5>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-4 col-xl-3 mb-3">
                <div class="card custom-card">
                    <div class="row">
                        <div class="col text-center mt-4 mb-2">
                            <h3 class="mb-4">Subscriptions</h3>
                            <i class="fas fa-file-invoice-dollar fa-5x my-3"></i>
                            <h3 class="card-title">{{subscriptions.current}}</h3>
                            <h5><a href="{% url 'dashboard_agency_plan_list' %}" class="card-link">View Subscriptions</a></h5>
                            <h5>&nbsp;</h5>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-4 col-xl-3 mb-3">
                <div class="card custom-card">
                    <div class="row">
                        <div class="col text-center my-2">
                            <h3>Employer <br/>Summary</h3>
                            <i class="fas fa-users fa-5x my-3"></i>
                            <h3 class="card-title">{{employers.current}}</h3>
                            <h5><a href="{% url 'employer_create_route' %}" class="card-link">Add Employer</a></h5>
                            <h5><a href="{% url 'employer_list_route' %}" class="card-link">View Employers</a></h5>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-4 col-xl-3 mb-3">
                <div class="card custom-card">
                    <div class="row">
                        <div class="col text-center mt-4 mb-2">
                            <h3 class="mb-4">Enquiries</h3>
                            <i class="fas fa-search fa-5x my-3"></i>
                            <h3 class="card-title">{{enquiries.current}}</h3>
                            <h5><a href="#" class="card-link">View Enquiries</a></h5>
                            <h5>&nbsp;</h5>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-4 col-xl-3 mb-3">
                <div class="card custom-card">
                    <div class="row">
                        <div class="col text-center my-2">
                            <h3>Sales <br/>Summary</h3>
                            <i class="fas fa-money-check fa-5x my-3"></i>
                            <h3 class="card-title">{{sales.current}}</h3>
                            <h5><a href="{% url 'sales_list_route' %}" class="card-link">View Sales</a></h5>
                            <h5>&nbsp;</h5>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-4 col-xl-3 mb-3">
                <div class="card custom-card">
                    <div class="row">
                        <div class="col text-center my-2">
                            <h3>Status <br/>Summary</h3>
                            <i class="fas fa-signal fa-5x my-3"></i>
                            <h3 class="card-title">&nbsp;</h3>
                            <h5><a href="{% url 'status_list_route' %}" class="card-link">View Status</a></h5>
                            <h5>&nbsp;</h5>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-4 col-xl-3 mb-3">
                <div class="card custom-card">
                    <div class="row">
                        <div class="col text-center my-2">
                            <h3>Billing <br/>History</h3>
                            <i class="fas fa-history fa-5x my-3"></i>
                            <h3 class="card-title">&nbsp;</h3>
                            <h5><a href="#" class="card-link">View History</a></h5>
                            <h5>&nbsp;</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col-xl-3">
                <div class="card custom-card">
                    <div class="row">
                        <div class="col text-center">
                            <h3>$100</h3>
                            <h5 class="text-success">100% up from last month</h5>
                            <h5 class="text-danger">20% down from this month last year</h5>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-8 col-xxl-6 offset-xxl-1">
                <div class="card custom-card card-wrapper-chart">
                    <div class="row">
                        <div class="col">
                            <h3 class="pl-3">Sales</h3>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 col-lg-2 offset-md-9 offset-lg-10 pr-4">
                            <label for="year-select-chart">Year</label>
                            <select name="year" id="year-select-chart" class="form-control">
                                <option value="2010">2010</option>
                                <option value="2011">2011</option>
                                <option value="2012">2012</option>
                                <option value="2013">2013</option>
                                <option value="2014">2014</option>
                                <option value="2015">2015</option>
                                <option value="2016">2016</option>
                                <option value="2017">2017</option>
                                <option value="2018">2018</option>
                                <option value="2019">2019</option>
                                <option value="2020">2020</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div id="chart">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xl-6">
                <div class="card custom-card card-wrapper-chart">
                    <div class="row">
                        <div class="col">
                            <h3 class="pl-3">Staff Performance</h3>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-2 offset-8 mb-2">
                            <label for="sales-staff-performance-chart-type">Type</label>
                            <select name="type" id="sales-staff-performance-chart-type" class="form-control">
                                <option value="sales">Sales</option>
                                <option value="cases">Cases</option>
                            </select>
                        </div>
                        <div class="col-2 pr-4 mb-2">
                            <label for="sales-staff-performance-chart-year">Year</label>
                            <select name="year" id="sales-staff-performance-chart-year" class="form-control">
                                <option value="2010">2010</option>
                                <option value="2011">2011</option>
                                <option value="2012">2012</option>
                                <option value="2013">2013</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div id="salesStaffPerformanceChart"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock dashboard_section %}
{% block js %}
<script>
    let months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    var branchSalesChartOptions = {
        series: [],
        chart: {
            height: 'auto',
            type: 'bar',
            toolbar: {
                show: false
            }
        },
        plotOptions: {
            bar: {
                borderRadius: 10,
                dataLabels: {
                    position: 'top', // top, center, bottom
                },
            }
        },
        dataLabels: {
            enabled: true,
            formatter: function (val) {
                return `$${val}`;
            },
            offsetY: -10,
            style: {
                fontSize: '.6rem',
                colors: ["#304758"]
            }
        },
        xaxis: {
            categories: [],
            position: 'top',
            axisBorder: {
                show: false
            },
            axisTicks: {
                show: false
            },
            crosshairs: {
                fill: {
                    type: 'gradient',
                    gradient: {
                        colorFrom: '#D8E3F0',
                        colorTo: '#BED1E6',
                        stops: [0, 100],
                        opacityFrom: 0.4,
                        opacityTo: 0.5,
                    }
                }
            },
            tooltip: {
                enabled: true,
            }
        },
        yaxis: {
            max: function(max) {
                return max * 1.1
            },
            axisBorder: {
                show: false
            },
            axisTicks: {
                show: false,
            },
            labels: {
                show: true,
                formatter: function (val) {
                    val = Math.round((val + Number.EPSILON) * 100) / 100
                    return `$${val}`;
                }
            }
        },
        title: {
            text: 'Branch Sales',
            floating: true,
            offsetY: 635,
            align: 'center',
            style: {
                color: '#444'
            }
        },
        noData: {
            text: 'Loading...'
        }
    };
    var chart = new ApexCharts(document.querySelector("#chart"), branchSalesChartOptions);
    chart.render();
    var salesStaffPerformanceChartOptions = {
        series: [],
        chart: {
            height: 'auto',
            type: 'line',
            toolbar: {
                show: false
            }
        },
        plotOptions: {
            bar: {
                borderRadius: 10,
                dataLabels: {
                    position: 'top', // top, center, bottom
                },
            }
        },
        dataLabels: {
            enabled: false,
            formatter: function (val) {
                return `$${val}`;
            },
            offsetY: -20,
            style: {
                fontSize: '1rem',
                colors: ["#304758"]
            }
        },
        xaxis: {
            categories: [],
            position: 'top',
            axisBorder: {
                show: false
            },
            axisTicks: {
                show: false
            },
            crosshairs: {
                fill: {
                    type: 'gradient',
                    gradient: {
                        colorFrom: '#D8E3F0',
                        colorTo: '#BED1E6',
                        stops: [0, 100],
                        opacityFrom: 0.4,
                        opacityTo: 0.5,
                    }
                }
            },
            tooltip: {
                enabled: true,
            }
        },
        yaxis: {
            min: function(min) {
                return min * 0.9
            },
            max: function(max) {
                return max * 1.1
            },
            axisBorder: {
                show: false
            },
            axisTicks: {
                show: false,
            },
            labels: {
                show: true,
                formatter: function (val) {
                    val = Math.round((val + Number.EPSILON) * 100) / 100
                    return `$${val}`;
                }
            }
        },
        stroke: {
            curve: 'smooth',
        },
        title: {
            text: 'Staff Sales Performance',
            floating: true,
            offsetY: 610,
            align: 'center',
            style: {
                color: '#444'
            }
        },
        noData: {
            text: 'Loading...'
        }
    }
    var salesStaffPerformanceChart = new ApexCharts(document.querySelector("#salesStaffPerformanceChart"), salesStaffPerformanceChartOptions);
    salesStaffPerformanceChart.render();
    
    const csrftoken = Cookies.get('csrftoken');
    const authority = '{{authority}}'
    $(function(){
        let salesChartYear = $('#year-select-chart').find(":selected").text();
        let salesStaffPerformanceChartYear = $('#sales-staff-performance-chart-year').find(':selected').text();
        let salesStaffPerformanceType = $('#sales-staff-performance-chart-type').find(':selected').text();
        let max = 0;
        axios({
            method: 'post',
            mode: 'same-origin',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            url: '/dashboard/data/',
            data: {
                'authority': authority,
                'chart': {
                    'name': 'salesChart',
                    'year': salesChartYear
                }
            }
        }).then(function (res) {
            if (res) {
                chart.updateSeries(res.data.data);
                let categories = months;
                res.data.data.forEach(el => {
                    if (el.data.length>max){
                        max=el.data.length
                    }
                });
                if (max != 12) {
                    categories = months.slice(0,max);
                }
                chart.updateOptions({
                    xaxis: {
                        categories: categories
                    },
                    responsive: [
                        {
                            breakpoint: 768,
                            options: {
                                dataLabels: {
                                    offsetY: -10,
                                    style: {
                                        fontSize: '.6rem',
                                    }
                                },
                            }
                        },
                        {
                            breakpoint: 992,
                            options: {
                                dataLabels: {
                                    offsetY: -10,
                                    style: {
                                        fontSize: '.8rem',
                                    }
                                },
                            }
                        },
                        {
                            breakpoint: 1200,
                            options: {
                                dataLabels: {
                                    offsetY: -10,
                                    style: {
                                        fontSize: '1rem',
                                    }
                                },
                            }
                        },
                        {
                            breakpoint: 1400,
                            options: {
                                dataLabels: {
                                    offsetY: -10,
                                    style: {
                                        fontSize: '1.2rem',
                                    }
                                },
                            }
                        },
                        {
                            breakpoint: 1978,
                            options: {
                                dataLabels: {
                                    offsetY: -15,
                                    style: {
                                        fontSize: '1.2rem',
                                    }
                                },
                            }
                        },
                        {
                            breakpoint: 2600,
                            options: {
                                dataLabels: {
                                    offsetY: -10,
                                    style: {
                                        fontSize: '1.6rem',
                                    }
                                },
                            }
                        }
                    ]
                })
            }
        })
        axios({
            method: 'post',
            mode: 'same-origin',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            url: '/dashboard/data/',
            data: {
                'authority': authority,
                'chart': {
                    'name': 'salesStaffPerformance' + salesStaffPerformanceType,
                    'year': salesChartYear
                }
            }
        }).then(function (res) {
            if (res) {
                salesStaffPerformanceChart.updateSeries(res.data.data);
                let categories = months;
                if (res.data.data.length != 12) {
                    let categories = months.slice(1,res.data.data.length+1);
                }
                salesStaffPerformanceChart.updateOptions({
                    xaxis: {
                        categories: categories
                    }
                })
            }
        })
    })
    $('#year-select-chart').on('change', function(event){
        salesChartYear = $(this).find(":selected").text()
        let max = 0;
        axios({
            method: 'post',
            mode: 'same-origin',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            url: '/dashboard/data/',
            data: {
                'authority': authority,
                'chart': {
                    'name': 'salesChart',
                    'year': salesChartYear
                }
            }
        }).then(function (res) {
            if (res) {
                chart.updateSeries(res.data.data);
                let categories = months;
                res.data.data.forEach(el => {
                    if (el.data.length>max){
                        max=el.data.length
                    }
                });
                if (max != 12) {
                    categories = months.slice(0,max);
                }
                chart.updateOptions({
                    xaxis: {
                        categories: categories
                    }
                })
            }
        })
    });
    $('#sales-staff-performance-chart-year').on('change', function(event){
        salesStaffPerformanceChartYear = $(this).find(":selected").text()
        salesStaffPerformanceType = $('#sales-staff-performance-chart-type').find(':selected').text();
        axios({
            method: 'post',
            mode: 'same-origin',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            url: '/dashboard/data/',
            data: {
                'authority': authority,
                'chart': {
                    'name': 'salesStaffPerformance' + salesStaffPerformanceType,
                    'year': salesStaffPerformanceChartYear
                }
            }
        }).then(function (res) {
            if (res) {
                salesStaffPerformanceChart.updateSeries(res.data.data);
                let categories = months;
                let max = 0
                let updatedOptions = {
                    xaxis: {
                        categories: categories
                    }
                }
                res.data.data.forEach(el => {
                    if (el.data.length>max){
                        max=el.data.length
                    }
                });
                if (max != 12) {
                    categories = months.slice(0,max);
                }
                if (salesStaffPerformanceType=='Cases'){
                    updatedOptions = {
                        xaxis: {
                            categories: categories
                        },
                        dataLabels: {
                            formatter: function (val) {
                                return `$${val}`;
                            }
                        },
                        yaxis: {
                            min: function(min) {
                                return min - 1
                            },
                            max: function(max) {
                                return max + 1
                            },
                            labels: {
                                show: true,
                                formatter: function (val) {
                                    val = Math.round(val)
                                    return val;
                                }
                            }
                        }
                    }
                }
                salesStaffPerformanceChart.updateOptions(updatedOptions);
            }
        })
    });
    $('#sales-staff-performance-chart-type').on('change', function(event){
        salesStaffPerformanceChartYear = $('#sales-staff-performance-chart-year').find(":selected").text()
        salesStaffPerformanceType = $('#sales-staff-performance-chart-type').find(':selected').text();
        axios({
            method: 'post',
            mode: 'same-origin',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            url: '/dashboard/data/',
            data: {
                'authority': authority,
                'chart': {
                    'name': 'salesStaffPerformance' + salesStaffPerformanceType,
                    'year': salesStaffPerformanceChartYear
                }
            }
        }).then(function (res) {
            if (res) {
                salesStaffPerformanceChart.updateSeries(res.data.data);
                let categories = months;
                let max = 0
                let updatedOptions = {}
                res.data.data.forEach(el => {
                    if (el.data.length>max){
                        max=el.data.length
                    }
                });
                if (res.data.data.length != 12) {
                    categories = months.slice(0,max);
                }
                if (salesStaffPerformanceType=='Cases'){
                    updatedOptions = {
                        xaxis: {
                            categories: categories
                        },
                        dataLabels: {
                            formatter: function (val) {
                                return `$${val}`;
                            }
                        },
                        yaxis: {
                            min: function(min) {
                                return min - 1
                            },
                            max: function(max) {
                                return max + 1
                            },
                            labels: {
                                show: true,
                                formatter: function (val) {
                                    val = Math.round(val)
                                    return val;
                                }
                            }
                        }
                    }
                } else {
                    updatedOptions = {
                        xaxis: {
                            categories: categories
                        },
                        dataLabels: {
                            formatter: function (val) {
                                return val;
                            }
                        },
                        yaxis: {
                            min: function(min) {
                                return min * 0.9
                            },
                            max: function(max) {
                                return max * 1.1
                            },
                            labels: {
                                show: true,
                                formatter: function (val) {
                                    val = Math.round((val + Number.EPSILON) * 100) / 100
                                    return `$${val}`;
                                }
                            }
                        }
                    }
                }
                console.log(updatedOptions)
                salesStaffPerformanceChart.updateOptions(updatedOptions);
            }
        })
    });

</script>
{% endblock js%}