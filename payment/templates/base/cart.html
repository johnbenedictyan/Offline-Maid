{% extends 'payment-base.html' %}
{% block payment_section %}
{% include 'sections/title-banner.html' with page_name='Cart' %}
<section>
    <div class="container">
        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4">
            {% for product_price in cart %}
                <div class="col mb-4">
                    {{product_price}}
                    <a href="{% url 'remove_from_cart' product_price.pk %}" class="btn btn-danger">Remove</a>
                </div>
            {% endfor %}
        </div>
        {% if cart_count > 0 %}
        <button id="checkout-btn" class="btn btn-primary">Checkout</button>
        {% endif %}
    </div>
</section>
{% endblock payment_section %}
{% block js %}
<script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
<script>
    window.onload = () => {
        let stripe = Stripe('pk_test_51I6Hj9KvEbGNaxrCUAuP3WLcbL1IhF7qDi3BP9vlfEAHClG55uWBnwsEFGaTjkk91AxKPIbSrbMJOJbJWAQ7aR4F00vitT5nV4');
        const csrftoken = Cookies.get('csrftoken');
        var createCheckoutSession = function() {
            return fetch(`${location.origin}/payment/create-checkout-session/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                mode: 'same-origin'
            }).then(function(result) {
                return result.json();
            });
        };
        document
        .getElementById("checkout-btn")
        .addEventListener("click", function(evt) {
            createCheckoutSession().then(function(data) {
            // Call Stripe.js method to redirect to the new Checkout page
            stripe
                .redirectToCheckout({
                sessionId: data.sessionId
                })
                .then(handleResult);
            });
        });
    }
</script>
{% endblock js %}